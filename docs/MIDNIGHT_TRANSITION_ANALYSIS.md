# Анализ: переход эфира на следующий день (полночь МСК)

## Краткий ответ

**Icecast source** — переключится на новый день (в течение ~30 сек после полуночи).  
**Backend /stream** — **НЕТ**: будет крутить вчерашний эфир по кругу.  
**HLS** — воспроизведение остановится в конце дня; нужен повторный Play.  
**Плеер** — не переключается сам, нужен повторный Play.

---

## 1. Icecast source (navo-radio-source)

**Поведение:** Переключается на новый день.

- В цикле каждые 30 сек вызывается `check_schedule`:
  - `new_hash = get_broadcast_schedule_hash(db, moscow_date())`
  - При смене даты хеш расписания меняется → стрим отменяется и перезапускается с новым днём.
- `ensure_broadcast_for_date` при отсутствии эфира на завтра копирует его с последней даты.

---

## 2. Backend /stream (fallback при Icecast 404)

**Поведение:** Не переключается на новый день.

- Дата берётся один раз при подключении: `req_date = d or moscow_date()`.
- `stream_broadcast` и `stream_broadcast_ffmpeg_concat` работают в бесконечном цикле (`while True` / `-stream_loop -1`).
- При достижении конца плейлиста индекс сбрасывается в 0 и тот же день крутится снова.
- Проверки даты при переходе через полночь нет.

**Итог:** Долгие сессии (через /stream) после полуночи продолжают воспроизводить вчерашний эфир.

---

## 3. HLS

**Поведение:** Останавливается в конце дня.

- HLS — VOD: фиксированный набор сегментов на один день.
- После последнего сегмента воспроизведение заканчивается.
- Автоматического перехода на следующий день нет.

---

## 4. Плеер (Player.jsx)

**Поведение:** Не переключается сам.

- `hlsUrl` и источник берутся в момент нажатия Play.
- При смене даты нет логики переподключения.
- `now-playing` опрашивается каждые 2 сек, но только для заголовка, не для смены источника.

---

## Рекомендации

1. **stream_broadcast** — перед зацикливанием проверять дату:
   - если `moscow_date() > broadcast_date` → завершать генератор (закрывать соединение).
   - Клиент при ошибке/закрытии сделает retry и получит новый день.

2. **Плеер** — опционально: при `handleAudioError` или при достижении конца HLS проверять, не сменилась ли дата, и переподключаться к новому дню.

3. **HLS** — при желании бесшовного перехода: генерировать HLS на следующий день заранее (например, cron в 23:00) и при окончании текущего дня переключать на следующий.
