# План починки HLS

## Проблема

1. **Таймаут** — FFmpeg прерывался через 1 ч. Для 877 слотов (~24 ч эфира) генерация занимает 40–70 мин.
2. **Результат** — HLS только ~9 ч вместо 24 ч → через 9 ч переключаемся на /stream (обрезает на стыках).

## Что сделано

- **Таймаут увеличен** до 2 ч (7200 сек) в `hls_service.py`.

## Что сделать дальше

### 1. Запустить полную генерацию HLS

В админке → Эфир → кнопка **«Сгенерировать HLS»** для сегодняшней даты.

Или с сервера:
```bash
cd /opt/navo-radio/backend
python run_hls.py 2026-02-21
```

Подождать 40–70 мин. Лог: `tail -f /opt/navo-radio/uploads/hls_generation.log`.

### 2. Проверить результат

- `/api/broadcast/hls-status?d=2026-02-21` — `exact_ready: true`
- Сегментов должно быть ~8640 (24 ч × 360 сек/ч ÷ 10 сек/сегмент)

### 3. Автогенерация (опционально)

Cron на 02:00 — генерировать HLS на сегодня:
```cron
0 2 * * * cd /opt/navo-radio/backend && python run_hls.py $(date +\%Y-\%m-\%d) >> /opt/navo-radio/uploads/hls_cron.log 2>&1
```

## /stream с FFmpeg concat (бесшовный, без предгенерации)

С 2026-02-21 `/stream` использует `stream_broadcast_ffmpeg_concat` — один FFmpeg, concat + реэнкод. Бесшовные переходы без HLS. Первый чанк может занять 20–40 сек (создание concat).

**«Сейчас играет»:** Позиция = `startSec + elapsed` (startSec с сервера при подключении). Метаданные из API `playlist-metadata`. Точность ±несколько секунд, достаточна для отображения текущего трека.

## Почему раньше /stream обрезал

`stream_broadcast_async` — конкатенация без реэнкода. На стыках разных битрейтов — щелчки. FFmpeg concat + реэнкод даёт единый формат.
