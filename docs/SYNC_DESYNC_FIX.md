# Рассинхрон эфира и админки — причина и решение

## Проблема

Подкаст (и другие элементы) звучат **раньше**, чем показывает админка «Сейчас играет».

## Причина

Эфир и админка используют **разные источники** для определения длительности:

| Компонент | Откуда берёт длительность | Результат |
|-----------|---------------------------|-----------|
| **Админка** (`get_now_playing`, сетка) | `BroadcastItem.duration_seconds` из БД | Показывает «сейчас играет» по расписанию |
| **Стрим** (Icecast, `/stream`) | Реальные аудиофайлы | Читает файлы до EOF = **фактическая** длительность |

Если реальная длительность файла **короче**, чем в БД:
- Стрим заканчивает трек раньше и переходит к следующему → следующий элемент «прозвучал раньше»
- Админка ещё считает, что идёт предыдущий слот
- Накопленная разница может достигать нескольких минут за несколько часов

## Когда это происходит

1. Заменили файл (подкаст, новости, погода) без пересчёта длительностей
2. Перегенерировали TTS с другой длительностью
3. `duration_seconds` в БД устарел (например, после замены файла)

## Решение

### 1. Использовать «Пересчитать длительности» после изменений

В админке → Эфир → кнопка **«Пересчитать длительности»** вызывает `/broadcast/recalc-durations`. Это приводит `BroadcastItem.duration_seconds` и расписание в соответствие с реальными файлами.

**Делайте пересчёт:**
- После замены любых аудиофайлов
- После перегенерации новостей/погоды
- Перед началом эфирного дня

### 2. Автоматический пересчёт при старте Icecast source (реализовано)

При каждом старте/переподключении `navo-radio-source` вызывает `recalc_broadcast_for_date` для сегодняшней даты. Длительности берутся из файлов (ffprobe), расписание пересчитывается — эфир и админка остаются синхронными.
